### general settings
set -g utf8 on
set -g status-utf8 on
set -g default-terminal 'screen-256color'
set -g history-limit 10000
set -g escape-time 0
set -g base-index 1
set -g renumber-windows on
set-window-option -g pane-base-index 1
set-window-option -g monitor-activity on

# disable italics
set -ga terminal-overrides ',*:sitm@,ritm@'

# desktop integration
set -g set-titles on
set -g set-titles-string '#{pane_current_command}: #{pane_title}'
set -g set-clipboard on

# mouse support
set -g mode-mouse on
set -g mouse-select-window on
set -g mouse-select-pane on
set -g mouse-resize-pane on

### keybindings {{{

set -g status-keys emacs
set -g mode-keys vi

# use C-` as the prefix key
unbind-key C-b
set -g prefix C-@
bind-key ` send-prefix
if-shell '[ -n "$SSH_CONNECTION" -o -n "$CYGWIN" ]' 'set -g prefix2 C-g'
if-shell '[ -n "$SSH_CONNECTION" -o -n "$CYGWIN" ]' 'bind-key g send-prefix -2'

# reload the tmux configuration
bind-key R source-file ~/.tmux.conf

# zoom current pane
bind-key + resize-pane -Z

# switch between windows
bind-key Space next-window

# scroll with PageUp/Down
bind-key -n S-PPage copy-mode -u
bind-key -t vi-copy S-NPage page-down

# copy mode bindings
bind-key -t vi-copy Home start-of-line
bind-key -t vi-copy End end-of-line
bind-key -t vi-copy ] cancel
bind-key -t vi-copy v begin-selection
unbind-key -t vi-copy C-j

# start new window in current directory (also requires PROMPT_COMMAND)
bind-key c new-window
bind-key C run-shell 'tmux new-window -c "$(tmux show-environment $(echo "TMUXPWD_#D" | tr -d %) | cut -d= -f2- | grep . || echo "$PWD")"'

bind-key s run-shell 'tmux split-window "cd $(tmux show-environment $(echo "TMUXPWD_#D" | tr -d %) | cut -d= -f2- | grep . || echo "$PWD"); exec bash --login"'
bind-key v run-shell 'tmux split-window -h "cd $(tmux show-environment $(echo "TMUXPWD_#D" | tr -d %) | cut -d= -f2- | grep . || echo "$PWD"); exec bash --login"'

# move existing windows into new pane in current window
bind-key S choose-window 'join-pane -v -s "%%"'
bind-key V choose-window 'join-pane -h -s "%%"'

### }}}

### plugins {{{

run-shell ~/.tmux/yank/yank.tmux
run-shell ~/.tmux/open/open.tmux

# copycat
set-option -g @copycat_search_C-f '(^|^\.|[[:space:]]|[[:space:]]\.|[[:space:]]\.\.|^\.\.)[[:alnum:]~_]*/[][[:alnum:]_.#$%&+=/@-]*(:[0-9]+)?'
set-option -g @copycat_search_C-u '(https?://|[[:alnum:]]+@[-_\.[:alnum:]]+:|ftp://)[[:alnum:]?=%/_.:,;~@!#$&()*+-]*'
set-option -g @copycat_search_C-e '[-_\.[:alnum:]]+@[-_\.[:alnum:]]+'
set-option -g @copycat_search_C-b '\b(bugs?|chores?|features?|fix(es)?)/[-[:alnum:]]+\b'
set-option -g @copycat_search_C-c '\b([0-9a-f]{7}|[0-9a-f]{32}|[0-9a-f]{40}|[0-9a-f]{64})\b'
bind-key C-p run-shell '~/.tmux/copycat/scripts/copycat_mode_start.sh ".*"; ~/.tmux/copycat/scripts/copycat_jump.sh "next"'
run-shell ~/.tmux/copycat/copycat.tmux

# powerline
set-environment -g POWERLINE_CONFIG_COMMAND ~/.tmux/powerline/scripts/powerline-config
source ~/.tmux/powerline/powerline/bindings/tmux/powerline.conf

if-shell '[ -n "$SSH_CONNECTION" ]' 'set-environment -g NORMAL_PROMPT " #H "' 'set-environment -g NORMAL_PROMPT ""'
if-shell '[ -n "$SSH_CONNECTION" ]' 'set-environment -g PREFIX_PROMPT " #H "' 'set-environment -g PREFIX_PROMPT ""'

set-option -g status-left '#{?client_prefix,#[fg=colour254]#[bg=colour24]#[bold]#[noitalics]#[nounderscore],#[fg=colour23]#[bg=colour159]#[bold]#[noitalics]#[nounderscore]}#{?client_prefix,#(echo "\$PREFIX_PROMPT"),#(echo "\$NORMAL_PROMPT")}#{?client_prefix,#[fg=colour24],#[fg=colour159]}#[bg=colour236]#[nobold]#(env \$POWERLINE_COMMAND \$POWERLINE_COMMAND_ARGS tmux left)'
set-option -g status-right '#[fg=colour248]#[fg=black,bg=colour248,bold] %H:%M '

# vim-tmux-navigator
bind-key    h run 'tmux select-pane -L'
bind-key    j run 'tmux select-pane -D'
bind-key    k run 'tmux select-pane -U'
bind-key    l run 'tmux select-pane -R'
bind-key    \ run 'tmux select-window -l'
bind-key  C-h run 'tmux select-pane -L'
bind-key  C-j run 'tmux select-pane -D'
bind-key  C-k run 'tmux select-pane -U'
bind-key  C-l run 'tmux select-pane -R'
bind-key  C-\ run 'tmux select-window -l'

bind-key -n C-h if 'expr "#{pane_title}" : ".* ◉$"' 'send-keys C-h'  'select-pane -L'
bind-key -n C-j if 'expr "#{pane_title}" : ".* ◉$"' 'send-keys C-j'  'select-pane -D'
bind-key -n C-k if 'expr "#{pane_title}" : ".* ◉$"' 'send-keys C-k'  'select-pane -U'
bind-key -n C-l if 'expr "#{pane_title}" : ".* ◉$"' 'send-keys C-l'  'select-pane -R'
bind-key -n C-\ if 'expr "#{pane_title}" : ".* ◉$"' 'send-keys C-\\' 'select-window -l'

### }}}
