#!/bin/bash

trap 'exit 1' INT

ROMS="/slack/games/roms"
METADATA=1

case "$1" in
  card)
    TARGET="/media/$USER/ROMS"
    NAME=$TARGET
    ;;

  deck)
    TARGET="steamdeck:"
    METADATA=0
    ;;

  powkiddy)
    TARGET="powkiddy:"
    ;;

  ls|list)
    total=0

    function format {
      printf '%-15s %10s %10s\n' "$@"
    }

    echo 'system                size       roms'
    echo '-------------------------------------'

    for path in "$ROMS"/*; do
      system=$( basename "$path" )
      size=$( du -shL "$path" | awk '{ print $1 }' )

      case "$system" in
        ports)
          count=$( find "$path" -maxdepth 1 -type d | wc -l )
          ;;
        *)
          count=$( find "$path" -maxdepth 1 -type f | wc -l )
          ;;
      esac
      total=$(( total + count ))
      format "$system" "$size" "$count"
    done

    echo '-------------------------------------'
    size=$( du -shL "$ROMS" | awk '{ print $1 }' )
    format "total" "$size" "$total"

    exit
    ;;

  *)
    echo "Usage: sync-roms [list|card|deck|powkiddy] [RSYNC-OPTIONS]"
    exit 255
    ;;
esac
shift

function rsync {
  command rsync -Wrv \
    --size-only \
    --copy-links \
    "$@"
}

if [[ "$TARGET" = *:* ]]; then
  NAME=${TARGET%%:*}
elif ! mountpoint -q "$TARGET"; then
  echo "$TARGET is not mounted."
  exit 1
fi

echo
echo -e " \e[1;32m●\e[22m \e[22mSyncing ROMs from \e[1m$ROMS\e[22m to \e[1m$NAME\e[22m...\e[0m"
rsync \
  --exclude '*.cfg' \
  --exclude '*.dsv' \
  --exclude '*.hi' \
  --exclude '*.nv' \
  --exclude '*.pure.zip' \
  --exclude '*.sav' \
  --exclude '*.srm' \
  --exclude '*.ssv' \
  --exclude '*.sv2' \
  --exclude '*.txt' \
  --exclude '.directory' \
  --exclude 'gamelist.xml' \
  --exclude 'systeminfo.txt' \
  --exclude 'systems.txt' \
  --exclude 'images' \
  --exclude 'mplayer' \
  --exclude 'ports' \
  --exclude 'savestates' \
  --exclude 'screenshots' \
  --exclude 'bios/Databases' \
  --exclude 'dreamcast/data' \
  --exclude 'pico-8/backup' \
  --exclude 'pico-8/bbs' \
  --exclude 'pico-8/carts' \
  --exclude 'pico-8/cdata' \
  --exclude 'pico-8/cstore' \
  --exclude 'pico-8/plates' \
  --exclude 'psp/PSP' \
  --exclude 'scummvm/games/.scummvm' \
  "$ROMS/" "$TARGET/roms/" "$@"

[ $METADATA = 1 ] || exit

echo
echo -e " \e[1;32m●\e[22m \e[22mSyncing ports from \e[1m$NAME\e[22m to \e[1m$ROMS\e[22m...\e[0m"
rsync \
  --delete \
  --exclude 'autoinstall' \
  --exclude 'PortMaster' \
  --exclude 'ThemeMaster' \
  --exclude 'SAVE' \
  --exclude 'saves' \
  "$TARGET/roms/ports/" "$ROMS/ports/" "$@"

echo
echo -e " \e[1;32m●\e[22m \e[22mSyncing metadata from \e[1m$NAME\e[22m to \e[1m$ROMS\e[22m...\e[0m"

if [ -d "$TARGET" ]; then
  gamelists=$( ls "$TARGET"/roms/*/gamelist.xml 2>/dev/null )
else
  gamelists=$( ssh "$NAME" 'ls roms/*/gamelist.xml 2>/dev/null' | sed -r "s/^/$NAME:/" )
fi

for gamelist in $gamelists; do
  path=$( dirname "$gamelist" )
  system=$( basename "$path" )

  [[ "$system" =~ ^(mplayer|ports)$ ]] && continue

  echo -e "   \e[1;32m- ${system}\e[0m"

  rsync \
    --info=stats0,flist0 \
    "$gamelist" "$ROMS/$system/gamelist.xml" "$@"

  rsync \
    --info=stats0,flist0 \
    --delete \
    "$path/images/" "$ROMS/$system/images/" "$@"
done

echo
