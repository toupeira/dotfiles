#!/bin/bash

pattern='.'

if [ -f Gemfile ]; then
  paths=`echo .bundle/ruby/*/{gems,bundler/gems}`
elif [ -f package.json ]; then
  paths='node_modules --ignore node_modules'
elif [ -d vim/bundle ]; then
  paths='vim/bundle'
elif [ -d .vim/bundle ]; then
  paths='.vim/bundle'
else
  paths='.'
fi

if [ $# -gt 0 ]; then
  args=( "$@" )
  pattern=''
  for (( i = 0; i < $#; i++ )); do
    pattern="$pattern|${args[i]}"
  done
  pattern="(${pattern:1})"
fi

files=( `ag -l --ignore spec --ignore test "$pattern" $paths` )

if [ ${#files[@]} -gt 1 ]; then
  files=( `echo "${files[@]}" | tr " " "\n" | sort | fzf` )
fi

[ -n "$files" ] && exec sensible-vim $files
