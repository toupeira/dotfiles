#!/bin/bash

CONTROL=~/.config/quodlibet/control
CONFIG=~/.config/quodlibet/config

DEFAULT_QUERY="\&(#(rating > 0.4), #(added < 1 year))"

command="$1"
argument="$2"

case "$command" in
  start-hidden)
    shift
    [ -f "$CONFIG" ] && sed -ri "s/^(query_text =).*/\1 $DEFAULT_QUERY/" "$CONFIG"
    quodlibet --run --start-hidden "$@" &>/dev/null &
    exit
    ;;
  start-playing)
    exec $0 start-hidden --play
    ;;
  start-stopped)
    exec $0 start-hidden --stop
    ;;
  rating)
    stars="Rating set to "

    for _ in $( seq 0.2 0.2 "$argument" ); do
      stars="$stars⭐"
    done

    notify-send -i quodlibet -h int:transient:1 "$( quodlibet --print-playing )" "$stars"
    ;;
esac

if [ ! -p "$CONTROL" ] || ! pgrep -x quodlibet &>/dev/null; then
  echo "Quod Libet is not running."
  exit 1
elif [ "$command" = "running" ]; then
  exit 0
fi

if [ -n "$argument" ]; then
  echo "$command $argument" > "$CONTROL"
else
  echo "$command" > "$CONTROL"
fi
