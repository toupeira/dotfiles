#!/bin/bash

unset options command title

while [ "${1:0:1}" = "-" ]; do
  case "$1" in
    -v)
      options="-v"
      ;;
    -e)
      shift
      command=( "$@" )
      shift $#
      break
      ;;
    -t)
      title="$2"
      shift
      ;;
  esac

  shift
done

if [ ${#command[@]} -eq 0 -a ! -f Procfile ]; then
  echo "Can't continue without a Procfile."
  exit 1
fi

title="${title:-$1}"
title="${title:-`basename "$PWD"`}"
title="@$title"
if [[ "$TERM" =~ ^screen ]]; then
  echo -ne "\033]0;$title\007\033k$title\033\\"
else
  echo -ne "\033]1;$title\007\033]2;$title\007"
fi

while true; do
  if [ ${#command[@]} -gt 0 ]; then
    "${command[@]}"
  elif [ -n "$1" ]; then
    shoreman <(grep $options "^$1\w*:" Procfile)
  else
    shoreman
  fi

  echo -ne "\e[0;36mRestart? \e[1;36m[Y/n]\e[0m "
  read -n 1 2>/dev/null || exit
  echo
  case "$REPLY" in
    [nN]) exit;;
       *) continue;;
  esac
done
